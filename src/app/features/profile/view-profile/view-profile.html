<!-- src/app/features/profile/view-profile/view-profile.html -->

@if (loading) {
<div class="animate-pulse">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    @for (i of [1,2,3,4]; track i) {
    <div class="h-14 bg-gray-200 rounded"></div>
    }
  </div>
</div>
}

@if (error && !loading) {
<div class="bg-red-50 border border-red-100 text-red-700 text-sm px-3 py-2 rounded flex items-center gap-2">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"
    stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round"
      d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
  </svg>
  {{ error }}
</div>
}
@if (success) {
<div class="bg-green-50 border border-green-100 text-green-700 text-sm px-3 py-2 rounded flex items-center gap-2">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"
    stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round"
      d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
  {{ success }}
</div>
}

<!-- ══════════════ VIEW MODE ══════════════ -->
@if (user && !loading && !editing) {
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
  <div>
    <label class="text-xs text-gray-500">FIRST NAME</label>
    <p class="font-medium mb-0">{{ user.firstName }}</p>
  </div>
  <div>
    <label class="text-xs text-gray-500">LAST NAME</label>
    <p class="font-medium mb-0">{{ user.lastName }}</p>
  </div>
  <div>
    <label class="text-xs text-gray-500">EMAIL</label>
    <div class="flex items-center gap-2">
      <span class="font-medium">{{ user.email }}</span>
      @if (user.isVerified) {
      <span class="inline-block bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded">Verified</span>
      } @else {
      <span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded">Unverified</span>
      }
    </div>
  </div>
  <div>
    <label class="text-xs text-gray-500">DATE OF BIRTH</label>
    <p class="font-medium mb-0">{{ formattedDob }}</p>
  </div>
  <div>
    <label class="text-xs text-gray-500">ROLE</label>
    <div>
      <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold"
        [class]="user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'">{{ user.role |
        titlecase }}</span>
    </div>
  </div>
  <div>
    <label class="text-xs text-gray-500">MEMBER SINCE</label>
    <p class="font-medium mb-0">{{ memberSince }}</p>
  </div>
</div>

<div class="mt-4">
  <button class="px-3 py-2 bg-green-600 text-white rounded text-sm inline-flex items-center gap-2"
    (click)="startEditing()">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
      stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
    </svg>
    Edit Profile
  </button>
</div>
}

<!-- ══════════════ EDIT MODE ══════════════ -->
@if (user && !loading && editing) {
<form [formGroup]="form" (ngSubmit)="saveProfile()">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">

    <!-- First Name -->
    <div>
      <label class="text-xs text-gray-500">FIRST NAME</label>
      <input type="text" class="border border-gray-200 rounded px-3 py-2 w-full" formControlName="firstName"
        placeholder="John" [class.border-red-500]="form.get('firstName')?.touched && form.get('firstName')?.invalid">
      @if (form.get('firstName')?.touched && form.get('firstName')?.invalid) {
      <div class="text-red-600 text-sm mt-1">
        @if (form.get('firstName')?.hasError('required')) { First name is required }
        @else if (form.get('firstName')?.hasError('minlength')) { Minimum 3 characters }
        @else if (form.get('firstName')?.hasError('pattern')) { Letters only }
      </div>
      }
    </div>

    <!-- Last Name -->
    <div>
      <label class="text-xs text-gray-500">LAST NAME</label>
      <input type="text" class="border border-gray-200 rounded px-3 py-2 w-full" formControlName="lastName"
        placeholder="Doe" [class.border-red-500]="form.get('lastName')?.touched && form.get('lastName')?.invalid">
      @if (form.get('lastName')?.touched && form.get('lastName')?.invalid) {
      <div class="text-red-600 text-sm mt-1">
        @if (form.get('lastName')?.hasError('required')) { Last name is required }
        @else if (form.get('lastName')?.hasError('minlength')) { Minimum 3 characters }
        @else if (form.get('lastName')?.hasError('pattern')) { Letters only }
      </div>
      }
    </div>

    <!-- Date of Birth -->
    <div>
      <label class="text-xs text-gray-500">DATE OF BIRTH <span class="text-gray-400 text-xs">(optional)</span></label>
      <input type="date" class="border border-gray-200 rounded px-3 py-2 w-full" formControlName="dob">
    </div>

    <!-- Email (read-only) -->
    <div>
      <label class="text-xs text-gray-500">EMAIL <span class="text-gray-400 text-xs">(cannot change)</span></label>
      <input type="email" class="border border-gray-100 bg-gray-50 rounded px-3 py-2 w-full" [value]="user.email"
        disabled>
    </div>
  </div>

  <div class="border-t my-4"></div>

  <div class="flex gap-2">
    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded inline-flex items-center gap-2"
      [disabled]="saving || form.invalid || form.pristine">
      @if (saving) {
      <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>Saving…
      } @else {
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
        stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
      </svg>
      Save Changes
      }
    </button>
    <button type="button" class="px-4 py-2 bg-gray-100 rounded" (click)="cancelEditing()"
      [disabled]="saving">Cancel</button>
  </div>
</form>
}