<!-- src/app/features/profile/view-profile/view-profile.html -->

<!-- Loading with enhanced skeleton -->
@if (loading) {
  <div class="animate-pulse space-y-8">
    <!-- Section titles skeleton -->
    <div>
      <div class="h-6 bg-gray-200 rounded w-32 mb-4"></div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        @for (i of [1, 2, 3, 4]; track i) {
          <div class="bg-gray-100 rounded-xl p-6 space-y-3">
            <div class="h-4 bg-gray-200 rounded w-24"></div>
            <div class="h-6 bg-gray-200 rounded w-32"></div>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Error Alert -->
@if (error && !loading) {
  <div class="rounded-xl bg-red-50 border border-red-200 text-red-700 px-6 py-4 text-sm mb-6 flex items-start gap-3 animate-in fade-in">
    <svg class="h-5 w-5 shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div>
      <p class="font-semibold">Error</p>
      <p class="text-sm mt-1">{{ error }}</p>
    </div>
  </div>
}

<!-- Success Alert -->
@if (success && !loading) {
  <div class="rounded-xl bg-green-50 border border-green-200 text-green-700 px-6 py-4 text-sm mb-6 flex items-start gap-3 animate-in fade-in">
    <svg class="h-5 w-5 shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div>
      <p class="font-semibold">Success</p>
      <p class="text-sm mt-1">{{ success }}</p>
    </div>
  </div>
}

<!-- ══════════════ VIEW MODE ══════════════ -->
@if (user && !loading && !editing) {
  <div class="space-y-8">
    <!-- Personal Information Section -->
    <div>
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Personal Information
          </h2>
          <p class="text-sm text-gray-500 mt-1">Your profile details and personal data</p>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- First Name Card -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">First Name</p>
          <p class="text-lg font-semibold text-gray-900">{{ user.firstName }}</p>
        </div>

        <!-- Last Name Card -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Last Name</p>
          <p class="text-lg font-semibold text-gray-900">{{ user.lastName }}</p>
        </div>

        <!-- Email Card with verified badge -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Email Address</p>
          <div class="flex items-center justify-between">
            <p class="text-lg font-semibold text-gray-900">{{ user.email }}</p>
            @if (user.isVerified) {
              <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
                Verified
              </span>
            } @else {
              <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">
                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Pending
              </span>
            }
          </div>
        </div>

        <!-- Date of Birth Card -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Date of Birth</p>
          <p class="text-lg font-semibold text-gray-900">{{ formattedDob || 'Not provided' }}</p>
        </div>
      </div>
    </div>

    <!-- Account Information Section -->
    <div>
      <div class="flex items-center gap-2 mb-6">
        <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
          <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m6 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Account Information
        </h2>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Role Badge -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Account Role</p>
          <span class="inline-block px-4 py-2 rounded-lg text-sm font-semibold capitalize"
            [class]="user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'">
            {{ user.role }}
          </span>
        </div>

        <!-- Member Since -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Member Since</p>
          <p class="text-lg font-semibold text-gray-900">{{ memberSince }}</p>
        </div>
      </div>
    </div>

    <!-- Edit Button -->
    <div class="flex gap-3 pt-6 border-t border-gray-100">
      <button
        (click)="startEditing()"
        class="flex-1 sm:flex-none px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-sm font-medium rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-200 inline-flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
        Edit Profile
      </button>
    </div>
  </div>
}

<!-- ══════════════ EDIT MODE ══════════════ -->
@if (user && !loading && editing) {
  <form [formGroup]="form" (ngSubmit)="saveProfile()" class="space-y-8 animate-in fade-in duration-300">
    <!-- Form Section -->
    <div>
      <h2 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4.243 4.243a2 2 0 000 2.828l4.243 4.243a4 4 0 005.656 0l4.243-4.243a2 2 0 000-2.828l-4.243-4.243z" />
        </svg>
        Edit Your Profile
      </h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- First Name -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">First Name *</label>
          <input
            type="text"
            formControlName="firstName"
            placeholder="John"
            class="w-full border border-gray-300 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white"
          />
          @if (form.get('firstName')?.touched && form.get('firstName')?.invalid) {
            <div class="mt-2 flex items-start gap-2">
              <svg class="h-4 w-4 text-red-500 shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="text-red-600 text-sm font-medium">
                @if (form.get('firstName')?.hasError('required')) {
                  First name is required
                } @else if (form.get('firstName')?.hasError('minlength')) {
                  Minimum 3 characters
                } @else if (form.get('firstName')?.hasError('pattern')) {
                  Letters only
                }
              </p>
            </div>
          }
        </div>

        <!-- Last Name -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name *</label>
          <input
            type="text"
            formControlName="lastName"
            placeholder="Doe"
            class="w-full border border-gray-300 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white"
          />
          @if (form.get('lastName')?.touched && form.get('lastName')?.invalid) {
            <div class="mt-2 flex items-start gap-2">
              <svg class="h-4 w-4 text-red-500 shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="text-red-600 text-sm font-medium">
                @if (form.get('lastName')?.hasError('required')) {
                  Last name is required
                } @else if (form.get('lastName')?.hasError('minlength')) {
                  Minimum 3 characters
                } @else if (form.get('lastName')?.hasError('pattern')) {
                  Letters only
                }
              </p>
            </div>
          }
        </div>

        <!-- Date of Birth -->
        <div class="sm:col-span-2">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Date of Birth
            <span class="text-gray-400 font-normal">(optional)</span>
          </label>
          <input
            type="date"
            formControlName="dob"
            [max]="'2025-12-31'"
            class="w-full border border-gray-300 rounded-xl px-4 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white"
          />
        </div>

        <!-- Email (Read-only) -->
        <div class="sm:col-span-2">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Email Address
            <span class="text-gray-400 font-normal">(cannot be changed)</span>
          </label>
          <input
            type="email"
            [value]="user.email"
            disabled
            class="w-full border border-gray-200 rounded-xl px-4 py-3 bg-gray-50 text-gray-500 placeholder-gray-400 cursor-not-allowed"
          />
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center gap-3 pt-6 border-t border-gray-100">
      <button
        type="submit"
        [disabled]="saving || form.invalid || form.pristine"
        class="flex-1 sm:flex-none px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-sm font-medium rounded-xl hover:from-blue-700 hover:to-blue-800 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed transition-all duration-200 inline-flex items-center justify-center gap-2 shadow-md hover:shadow-lg disabled:shadow-none"
      >
        @if (saving) {
          <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" />
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
          </svg>
          Saving…
        } @else {
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
          Save Changes
        }
      </button>
      <button
        type="button"
        (click)="cancelEditing()"
        [disabled]="saving"
        class="flex-1 sm:flex-none px-8 py-3 text-gray-700 bg-gray-100 text-sm font-medium rounded-xl hover:bg-gray-200 disabled:bg-gray-100 disabled:cursor-not-allowed transition-all duration-200"
      >
        Cancel
      </button>
    </div>
  </form>
}
