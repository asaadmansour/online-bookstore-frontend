<!-- src/app/features/order-history/order-detail/order-detail.html -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <a routerLink="/orders" class="text-sm text-text-muted hover:text-text-main inline-flex items-center gap-1 mb-3 transition-colors">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
      stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
    </svg>
    Back to Orders
  </a>

  @if (loading) {
  <div class="space-y-3">
    <div class="h-8 bg-bg-soft rounded w-1/3"></div>
    <div class="h-20 bg-bg-soft rounded w-full"></div>
    <div class="h-48 bg-bg-soft rounded w-full"></div>
  </div>
  }

  @if (error && !loading) {
  <div class="bg-white rounded-lg shadow-sm text-center py-8">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-red-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24"
      stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
    <h6 class="font-semibold">Order not found</h6>
    <p class="text-sm text-text-muted">{{ error }}</p>
    <a routerLink="/orders" class="inline-block mt-3 px-3 py-1 bg-accent hover:bg-accent-hover text-white text-sm rounded transition-colors">Back to Orders</a>
  </div>
  }

  @if (order && !loading) {
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between md:items-center gap-3 mb-4">
    <div>
      <h4 class="font-bold mb-1">Order #{{ order._id.slice(-8).toUpperCase() }}</h4>
      <span class="text-sm text-text-muted">{{ order.createdAt | date: 'MMMM d, y — h:mm a' }}</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold badge-status-{{ order.status }}">{{
        order.status | titlecase }}</span>
    </div>
  </div>

  <!-- Timeline -->
  <div class="bg-white rounded-lg shadow-sm mb-4 p-4">
    <div class="flex justify-between items-center">
      @for (step of timelineSteps; track step.label; let i = $index; let last = $last) {
      <div class="text-center" style="z-index:1">
        <div class="mx-auto mb-2 flex items-center justify-center rounded-full" style="width:40px;height:40px"
          [class]="step.done ? (step.active ? 'bg-blue-600 text-white' : 'bg-accent text-white') : 'bg-bg-soft text-text-muted border border-border-light'">>
          @if (step.done && !step.active) {
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
          } @else {
          <span class="font-semibold text-sm">{{ i + 1 }}</span>
          }
        </div>
        <small [class]="step.done ? 'font-semibold text-sm text-text-main' : 'text-sm text-text-muted'">{{ step.label }}</small>
      </div>
      }
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Items -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="px-4 py-3 border-b">
          <h6 class="font-semibold mb-0">Items ({{ totalQuantity }})</h6>
        </div>

        @if (order.items.length === 0) {
        <div class="p-6 text-center text-text-muted">No items</div>
        }

        @for (item of order.items; track trackByItemId($index, item)) {
        <div class="flex items-center gap-3 px-4 py-4 border-b">
          @if (item.book?.coverUrl) {
          <img [src]="item.book?.coverUrl" [alt]="item.book?.name" class="rounded"
            style="width:60px;height:75px;object-fit:cover" />
          } @else {
          <div class="bg-bg-soft rounded flex items-center justify-center" style="width:60px;height:75px">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-text-muted" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
            </svg>
          </div>
          }
          <div class="flex-1">
            @if (item.book) {
            <h6 class="mb-0 font-semibold">{{ item.book.name }}</h6>
            @if (item.book.author.name) {
            <small class="text-sm text-text-muted">by {{ item.book.author.name }}</small>
            }
            } @else {
            <h6 class="mb-0 text-text-muted italic">Book unavailable</h6>
            }
            <small class="text-sm text-text-muted block mt-1">Qty: {{ item.quantity }} · {{ item.unitPrice | currency }}</small>
          </div>
          <div class="font-semibold">{{ item.unitPrice * item.quantity | currency }}</div>
        </div>
        }
      </div>
    </div>

    <!-- Sidebar -->
    <div>
      <!-- Summary -->
      <div class="bg-white rounded-lg shadow-sm mb-4 p-4">
        <h6 class="font-semibold mb-3">Order Summary</h6>
        <div class="flex justify-between text-sm text-text-muted mb-2"><span>Subtotal</span><span>{{ subtotal | currency }}</span></div>
        <div class="flex justify-between text-sm text-text-muted mb-2"><span>Shipping</span><span
            class="text-accent font-medium">Free</span></div>
        @if (order.total_price !== subtotal) {
        <div class="flex justify-between text-sm text-text-muted mb-2"><span>Tax</span><span>{{ order.total_price - subtotal | currency }}</span></div>
        }
        <div class="border-t mt-3 pt-3 flex justify-between"><span class="font-semibold">Total</span><span
            class="font-semibold text-lg">{{ order.total_price | currency }}</span></div>
      </div>

      <!-- Shipping -->
      <div class="bg-white rounded-lg shadow-sm p-4">
        <h6 class="font-semibold mb-2 inline-flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
          </svg>
          Shipping
        </h6>
        <div class="text-sm text-text-muted">
          <p class="mb-1">{{ order.shipping_address.street }}</p>
          <p class="mb-1">{{ order.shipping_address.city }}, {{ order.shipping_address.state }} {{
            order.shipping_address.zip }}</p>
          <p class="mb-3">{{ order.shipping_address.country }}</p>
          <div class="border-t pt-3 flex justify-between items-center"><span>Payment</span><span
              class="uppercase font-medium">{{ order.payment_method }}</span></div>
        </div>
      </div>
    </div>
  </div>
  }
</div>