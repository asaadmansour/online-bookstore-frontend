import{d as p,k as g}from"./chunk-Q3W3MUE3.js";import{J as i,N as a,S as l,f as u,h}from"./chunk-6EE3YYJG.js";var c=class s{ACCESS_KEY="accessToken";REFRESH_KEY="refreshToken";setTokens(e,t){localStorage.setItem(this.ACCESS_KEY,e),localStorage.setItem(this.REFRESH_KEY,t)}getAccessToken(){return localStorage.getItem(this.ACCESS_KEY)}getRefreshToken(){return localStorage.getItem(this.REFRESH_KEY)}clearTokens(){localStorage.removeItem(this.ACCESS_KEY),localStorage.removeItem(this.REFRESH_KEY)}decodeToken(e){try{let o=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(atob(o))}catch{return null}}isTokenExpired(e){if(!e)return!0;let t=this.decodeToken(e);return t?.exp?t.exp*1e3<=Date.now()+3e4:!0}isLoggedIn(){return!this.isTokenExpired(this.getRefreshToken())}getUserRole(){let e=this.getAccessToken();return e?this.decodeToken(e)?.role??null:null}getUserId(){let e=this.getAccessToken();return e?this.decodeToken(e)?.userId??null:null}static \u0275fac=function(t){return new(t||s)};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};var d={production:!1,apiUrl:"http://localhost:5000"};var n="currentUser",k=class s{api=`${d.apiUrl}/auth`;userSubject=new h(this.storedUser());currentUser$=this.userSubject.asObservable();http=l(p);token=l(c);router=l(g);storedUser(){try{let e=localStorage.getItem(n);return e&&this.token.isLoggedIn()?JSON.parse(e):null}catch{return null}}get currentUser(){return this.userSubject.value}get isLoggedIn(){return this.token.isLoggedIn()}updateCurrentUser(e){this.userSubject.next(e),localStorage.setItem(n,JSON.stringify(e))}register(e){return this.http.post(`${this.api}/register`,e).pipe(i(t=>this.handleAuth(t)))}login(e){return this.http.post(`${this.api}/login`,e).pipe(i(t=>this.handleAuth(t)))}refreshToken(){let e=this.token.getRefreshToken();return this.http.post(`${this.api}/refresh`,{refreshToken:e}).pipe(i(t=>this.token.setTokens(t.accessToken,t.refreshToken)))}logout(){let e=this.token.getRefreshToken(),t=this.token.getUserId(),o=this.token.getAccessToken();if(e&&t){let r=o?{headers:{Authorization:`Bearer ${o}`}}:void 0;this.http.post(`${this.api}/logout`,{userId:t,refreshToken:e},r).subscribe({next:()=>console.log("Server: refresh token invalidated"),error:()=>console.warn("Server logout failed \u2014 tokens cleared locally")})}this.clearAllState(),this.router.navigate(["/auth/login"])}logoutWithConfirmation(){let e=this.token.getRefreshToken(),t=this.token.getUserId(),o=this.token.getAccessToken();return new u(r=>{if(e&&t){let f=o?{headers:{Authorization:`Bearer ${o}`}}:void 0;this.http.post(`${this.api}/logout`,{userId:t,refreshToken:e},f).subscribe({next:m=>{this.clearAllState(),r.next(m),r.complete()},error:()=>{this.clearAllState(),r.next({message:"Logged out locally"}),r.complete()}})}else this.clearAllState(),r.next({message:"Logged out"}),r.complete()})}forceLogout(){this.clearState(),this.router.navigate(["/"])}verifyEmail(e){return this.http.post(`${this.api}/verify-email`,{verificationCode:e})}resendVerification(e){return this.http.post(`${this.api}/resend-verification`,{email:e})}handleAuth(e){this.token.setTokens(e.tokens.accessToken,e.tokens.refreshToken),this.userSubject.next(e.user),localStorage.setItem(n,JSON.stringify(e.user))}clearState(){this.token.clearTokens(),this.userSubject.next(null),localStorage.removeItem(n)}clearAllState(){this.token.clearTokens(),localStorage.removeItem(n),this.userSubject.next(null)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};export{c as a,d as b,k as c};
