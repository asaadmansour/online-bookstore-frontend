import{a as d}from"./chunk-HOACR73J.js";import{c as p,h as g}from"./chunk-X5XJS3OX.js";import{F as i,J as a,N as l,f as u,h}from"./chunk-QMVCZU7Z.js";var c=class s{ACCESS_KEY="accessToken";REFRESH_KEY="refreshToken";setTokens(e,t){localStorage.setItem(this.ACCESS_KEY,e),localStorage.setItem(this.REFRESH_KEY,t)}getAccessToken(){return localStorage.getItem(this.ACCESS_KEY)}getRefreshToken(){return localStorage.getItem(this.REFRESH_KEY)}clearTokens(){localStorage.removeItem(this.ACCESS_KEY),localStorage.removeItem(this.REFRESH_KEY)}decodeToken(e){try{let r=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(atob(r))}catch{return null}}isTokenExpired(e){if(!e)return!0;let t=this.decodeToken(e);return t?.exp?t.exp*1e3<=Date.now()+3e4:!0}isLoggedIn(){return!this.isTokenExpired(this.getRefreshToken())}getUserRole(){let e=this.getAccessToken();return e?this.decodeToken(e)?.role??null:null}getUserId(){let e=this.getAccessToken();return e?this.decodeToken(e)?.userId??null:null}static \u0275fac=function(t){return new(t||s)};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};var n="currentUser",k=class s{constructor(e,t,r){this.http=e;this.token=t;this.router=r}api=`${d.apiUrl}/auth`;userSubject=new h(this.storedUser());currentUser$=this.userSubject.asObservable();storedUser(){try{let e=localStorage.getItem(n);return e&&this.token.isLoggedIn()?JSON.parse(e):null}catch{return null}}get currentUser(){return this.userSubject.value}get isLoggedIn(){return this.token.isLoggedIn()}updateCurrentUser(e){this.userSubject.next(e),localStorage.setItem(n,JSON.stringify(e))}register(e){return this.http.post(`${this.api}/register`,e).pipe(i(t=>this.handleAuth(t)))}login(e){return this.http.post(`${this.api}/login`,e).pipe(i(t=>this.handleAuth(t)))}refreshToken(){let e=this.token.getRefreshToken();return this.http.post(`${this.api}/refresh`,{refreshToken:e}).pipe(i(t=>this.token.setTokens(t.accessToken,t.refreshToken)))}logout(){let e=this.token.getRefreshToken(),t=this.token.getUserId(),r=this.token.getAccessToken();if(e&&t){let o=r?{headers:{Authorization:`Bearer ${r}`}}:void 0;this.http.post(`${this.api}/logout`,{userId:t,refreshToken:e},o).subscribe({next:()=>console.log("Server: refresh token invalidated"),error:()=>console.warn("Server logout failed \u2014 tokens cleared locally")})}this.clearAllState(),this.router.navigate(["/"])}logoutWithConfirmation(){let e=this.token.getRefreshToken(),t=this.token.getUserId(),r=this.token.getAccessToken();return new u(o=>{if(e&&t){let m=r?{headers:{Authorization:`Bearer ${r}`}}:void 0;this.http.post(`${this.api}/logout`,{userId:t,refreshToken:e},m).subscribe({next:f=>{this.clearAllState(),o.next(f),o.complete()},error:()=>{this.clearAllState(),o.next({message:"Logged out locally"}),o.complete()}})}else this.clearAllState(),o.next({message:"Logged out"}),o.complete()})}forceLogout(){this.clearState(),this.router.navigate(["/"])}verifyEmail(e){return this.http.post(`${this.api}/verify-email`,{verificationCode:e})}resendVerification(e){return this.http.post(`${this.api}/resend-verification`,{email:e})}handleAuth(e){this.token.setTokens(e.tokens.accessToken,e.tokens.refreshToken),this.userSubject.next(e.user),localStorage.setItem(n,JSON.stringify(e.user))}clearState(){this.token.clearTokens(),this.userSubject.next(null),localStorage.removeItem(n)}clearAllState(){this.token.clearTokens(),localStorage.removeItem(n),this.userSubject.next(null)}static \u0275fac=function(t){return new(t||s)(l(p),l(c),l(g))};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};export{c as a,k as b};
